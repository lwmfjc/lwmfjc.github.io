<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="redis集群搭建">
<meta property="og:type" content="article">
<meta property="og:title" content="redis集群搭建">
<meta property="og:url" content="http://example.com/2023/04/13/study/redis/redis-cluster/index.html">
<meta property="og:site_name" content="随记">
<meta property="og:description" content="redis集群搭建">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-04-13T23:27:30.000Z">
<meta property="article:modified_time" content="2023-04-13T23:27:30.000Z">
<meta property="article:author" content="刘易">
<meta property="article:tag" content="rocketmq-hm">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/2023/04/13/study/redis/redis-cluster/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>redis集群搭建 | 随记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">随记</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/04/13/study/redis/redis-cluster/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/lwmfjc/lwmfjc.github.io.resource/main/img/avatar.png">
      <meta itemprop="name" content="刘易">
      <meta itemprop="description" content="知命不惧 日日自新">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          redis集群搭建
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-04-13 23:27:30" itemprop="dateCreated datePublished" datetime="2023-04-13T23:27:30+00:00">2023-04-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">学习</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>32k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>59 分钟</span>
            </span>
            <div class="post-description">redis集群搭建</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>转载自https://www.cnblogs.com/Yunya-Cnblogs/p/14608937.html（添加小部分笔记）感谢作者!</p>
<p>部分参考自 https://www.cnblogs.com/ysocean/p/12328088.html</p>
</blockquote>
<h1 id="基本准备">基本准备</h1>
<h2 id="架构">架构</h2>
<p>采用Centos7，Redis版本为6.2，架构如下：</p>
<figure>
<img
src="https://raw.githubusercontent.com/lwmfjc/lwmfjc.github.io.resource/main/img/image-20230414104528632.png"
alt="image-20230414104528632" />
<figcaption aria-hidden="true">image-20230414104528632</figcaption>
</figure>
<h2 id="hosts修改">hosts修改</h2>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">添加</span></span><br><span class="line">192.168.1.101 node1</span><br><span class="line">192.168.1.102 node2</span><br><span class="line">192.168.1.103 node3</span><br></pre></td></tr></table></figure>
<h2 id="集群准备">集群准备</h2>
<h3 id="对每个节点">对每个节点</h3>
<ol type="1">
<li><p>下载redis并解压到 /usr/local/redis-cluster中</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /usr/local</span><br><span class="line">mkdir redis-cluster</span><br><span class="line">tar -zxvf redis* -C /usr/local/redis*</span><br></pre></td></tr></table></figure></li>
<li><p>进入redis根目录</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure></li>
<li><p>安装完毕</p></li>
<li><p>hosts修改</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">添加</span></span><br><span class="line">192.168.1.101 node1</span><br><span class="line">192.168.1.102 node2</span><br><span class="line">192.168.1.103 node3</span><br></pre></td></tr></table></figure></li>
</ol>
<h2
id="配置文件修改6个节点中的每一个">配置文件修改(6个节点中的每一个)</h2>
<p>创建多级目录</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir -p /usr/local/redis_cluster/redis_63&#123;79,80&#125;/&#123;conf,pid,logs&#125;</span><br></pre></td></tr></table></figure>
<figure>
<img
src="https://raw.githubusercontent.com/lwmfjc/lwmfjc.github.io.resource/main/img/image-20230414144223428.png"
alt="image-20230414144223428" />
<figcaption aria-hidden="true">image-20230414144223428</figcaption>
</figure>
<p>编写配置文件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vim /usr/local/redis_cluster/redis_6379/conf/redis.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">命令行状态下输入 :%d  回车，清空文件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">再输入 :<span class="built_in">set</span> <span class="built_in">paste</span> 处理多出的行带<span class="comment">#的问题</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">再输入i</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###内容#####</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">快速修改：:%s/6379/6380/g</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">守护进行模式启动</span></span><br><span class="line">daemonize yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置数据库数量，默认数据库为0</span></span><br><span class="line">databases 16</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">绑定地址，需要修改</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">bind</span> 192.168.1.101</span></span><br><span class="line">bind node1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">绑定端口，需要修改</span></span><br><span class="line">port 6379</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pid文件存储位置，文件名需要修改</span></span><br><span class="line">pidfile /usr/local/redis_cluster/redis_6379/pid/redis_6379.pid</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">log</span>文件存储位置，文件名需要修改</span></span><br><span class="line">logfile /usr/local/redis_cluster/redis_6379/logs/redis_6379.log</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">RDB快照备份文件名，文件名需要修改</span></span><br><span class="line">dbfilename redis_6379.rdb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">本地数据库存储目录，需要修改</span></span><br><span class="line">dir /usr/local/redis_cluster/redis_6379</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">集群相关配置</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否以集群模式启动</span></span><br><span class="line">cluster-enabled yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">集群节点回应最长时间，超过该时间被认为下线</span></span><br><span class="line">cluster-node-timeout 15000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成的集群节点配置文件名，文件名需要修改</span></span><br><span class="line">cluster-config-file nodes_6379.conf</span><br></pre></td></tr></table></figure>
<p>复制粘贴配置文件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cp /usr/local/redis_cluster/redis_6379/conf/redis.conf /usr/local/redis_cluster/redis_6380/conf/redis.conf</span><br><span class="line">vim  /usr/local/redis_cluster/redis_6380/conf/redis.conf</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">命令行模式下 :%s/6379/6380/g</span></span><br></pre></td></tr></table></figure>
<p>查看文件夹当前情况</p>
<figure>
<img
src="https://raw.githubusercontent.com/lwmfjc/lwmfjc.github.io.resource/main/img/image-20230414163620369.png"
alt="image-20230414163620369" />
<figcaption aria-hidden="true">image-20230414163620369</figcaption>
</figure>
<h1 id="运行">运行</h1>
<p>查看端口是否运行</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">netstat -lntup | grep 6379</span><br></pre></td></tr></table></figure>
<p>运行</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-server /usr/local/redis_cluster/redis_6379/conf/redis.conf &amp;</span><br><span class="line">redis-server /usr/local/redis_cluster/redis_6380/conf/redis.conf &amp;</span><br></pre></td></tr></table></figure>
<p>结果</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">netstat -lntup |grep 6379</span><br><span class="line">tcp        0      0 192.168.1.101:6379      0.0.0.0:*               LISTEN      6538/redis-server 1 </span><br><span class="line">tcp        0      0 192.168.1.101:16379     0.0.0.0:*               LISTEN      6538/redis-server 1</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">+10000端口出现，说明集群各个节点之间可以互相通信</span></span><br></pre></td></tr></table></figure>
<p>结果<br />
<img
src="https://raw.githubusercontent.com/lwmfjc/lwmfjc.github.io.resource/main/img/image-20230414163942512.png"
alt="image-20230414163942512" /></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat *6379/pid/*pid*      </span><br><span class="line">6538  ##就是上面的进程id</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat *6379/logs/*log</span><br><span class="line">6538:C 14 Apr 2023 16:37:04.893 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><br><span class="line">6538:C 14 Apr 2023 16:37:04.893 # Redis version=6.2.6, bits=64, commit=00000000, modified=0, pid=6538, just started</span><br><span class="line">6538:C 14 Apr 2023 16:37:04.893 # Configuration loaded</span><br><span class="line">6538:M 14 Apr 2023 16:37:04.895 * Increased maximum number of open files to 10032 (it was originally set to 1024).</span><br><span class="line">6538:M 14 Apr 2023 16:37:04.895 * monotonic clock: POSIX clock_gettime</span><br><span class="line">6538:M 14 Apr 2023 16:37:04.898 * No cluster configuration found, I&#x27;m e13c04818944108ee3b0690d836466b4c0eb69fd</span><br><span class="line">6538:M 14 Apr 2023 16:37:04.929 * Running mode=cluster, port=6379.</span><br><span class="line">6538:M 14 Apr 2023 16:37:04.929 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span><br><span class="line">6538:M 14 Apr 2023 16:37:04.929 # Server initialized</span><br><span class="line">6538:M 14 Apr 2023 16:37:04.929 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add &#x27;vm.overcommit_memory = 1&#x27; to /etc/sysctl.conf and then reboot or run the command &#x27;sysctl vm.overcommit_memory=1&#x27; for this to take effect.</span><br><span class="line">6538:M 14 Apr 2023 16:37:04.930 * Ready to accept connections</span><br></pre></td></tr></table></figure>
<p>集群节点配置文件，会发现生成了一组集群信息<br />
# 第一段信息是这个Redis服务作为集群节点的一个身份编码 #
别名为集群的node-id</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat *6379/*nodes*conf</span><br><span class="line">e13c04818944108ee3b0690d836466b4c0eb69fd :0@0 myself,master - 0 0 0 connected</span><br><span class="line">vars currentEpoch 0 lastVoteEpoch 0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 当后续所有节点都连接上时，内容会变成：</span></span></span><br><span class="line">ls</span><br><span class="line">conf  logs  nodes_6379.conf  pid  redis_6379.rdb</span><br><span class="line"></span><br><span class="line">root@centos7101:local/redis_cluster/redis_6379                                                                                                                          </span><br><span class="line">cat nodes_6379.conf </span><br><span class="line">f6cf3978d3397582c87480f8c335297675d4354a 192.168.1.103:6380@16380 master - 1681470597368 1681470597337 6 connected 0-5461</span><br><span class="line">f1151c2350820b35e117d3c32b59b64917688745 192.168.1.103:6379@16379 master - 1681470597369 1681470597337 5 connected 10923-16383</span><br><span class="line">83bfb30e39e3040397d995a7b1f560e8fb53c6a9 192.168.1.102:6380@16380 slave f1151c2350820b35e117d3c32b59b64917688745 1681470597369 1681470597337 5 connected</span><br><span class="line">4e9452afe7a8f53dc546b0436109bef570e03888 192.168.1.101:6380@16380 slave 95b2dcd681674398d22817728af08c31d4bd4872 1681470597370 1681470597337 4 connected</span><br><span class="line">95b2dcd681674398d22817728af08c31d4bd4872 192.168.1.102:6379@16379 master - 1681470597370 1681470597337 4 connected 5462-10922</span><br><span class="line">fd6acb4af8afa5ddd31cf559ee2c80ffcbea456f 192.168.1.101:6379@16379 myself,slave f6cf3978d3397582c87480f8c335297675d4354a 0 1681470597337 6 connected</span><br><span class="line">vars currentEpoch 6 lastVoteEpoch 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="集群搭建">集群搭建</h1>
<h2 id="手动搭建集群">手动搭建集群</h2>
<h3 id="加入集群">加入集群</h3>
<p>在node1:6379 查看当前cluster</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-cli -h node1 -p 6379</span><br><span class="line">node1:6379&gt; cluster nodes</span><br><span class="line">e13c04818944108ee3b0690d836466b4c0eb69fd :6379@16379 myself,master - 0 0 0 connected</span><br><span class="line">node1:6379&gt; cluster meet 192.168.1.102 6379</span><br><span class="line">OK</span><br><span class="line">node1:6379&gt; cluster nodes</span><br><span class="line">e13c04818944108ee3b0690d836466b4c0eb69fd 192.168.1.101:6379@16379 myself,master - 0 0 1 connected</span><br><span class="line">fbe66448ee1baefa6e9fbd55e778c1d09054b59a 192.168.1.102:6379@16379 master - 0 1681464479300 0 connected</span><br><span class="line">node1:6379&gt; </span><br></pre></td></tr></table></figure>
<p>此时在node2:6379查看当前cluster</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-cli -h node2 -p 6379</span><br><span class="line">node2:6379&gt; cluster nodes</span><br><span class="line">fbe66448ee1baefa6e9fbd55e778c1d09054b59a 192.168.1.102:6379@16379 myself,master - 0 0 0 connected</span><br><span class="line">e13c04818944108ee3b0690d836466b4c0eb69fd 192.168.1.101:6379@16379 master - 0 1681464547007 1 connected</span><br></pre></td></tr></table></figure>
<p>切回node1:6379，将剩下的节点meet上</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">node1:6379&gt; cluster meet 192.168.1.103 6379</span><br><span class="line">OK</span><br><span class="line">node1:6379&gt; cluster meet 192.168.1.101 6380</span><br><span class="line">OK</span><br><span class="line">node1:6379&gt; cluster meet 192.168.1.102 6380</span><br><span class="line">OK</span><br><span class="line">node1:6379&gt; cluster meet 192.168.1.103 6380</span><br><span class="line">OK</span><br><span class="line">node1:6379&gt; clear</span><br><span class="line">node1:6379&gt; cluster nodes</span><br><span class="line">84384230f256fae73ab5bbaf34b0479b67602d6e 192.168.1.102:6380@16380 master - 0 1681464635860 4 connected</span><br><span class="line">e13c04818944108ee3b0690d836466b4c0eb69fd 192.168.1.101:6379@16379 myself,master - 0 1681464633000 1 connected</span><br><span class="line">fbe66448ee1baefa6e9fbd55e778c1d09054b59a 192.168.1.102:6379@16379 master - 0 1681464636894 0 connected</span><br><span class="line">43cdb0cd626a0341cf0c9fa31832735c5341a89b 192.168.1.103:6380@16380 master - 0 1681464635000 5 connected</span><br><span class="line">a20b6da956145cfa06ed55159456de8259d9f246 192.168.1.103:6379@16379 master - 0 1681464637923 2 connected</span><br><span class="line">4aeeaa0d87b91712576c6e995b355fe4a87b24e0 192.168.1.101:6380@16380 master - 0 1681464637000 3 connected</span><br></pre></td></tr></table></figure>
<h3 id="主从配置">主从配置</h3>
<p>上面发现的node-id</p>
<table>
<colgroup>
<col style="width: 12%" />
<col style="width: 27%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="header">
<th>hostname</th>
<th>节点</th>
<th>node-id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>node1</td>
<td>192.168.1.101:6379</td>
<td>e13c04818944108ee3b0690d836466b4c0eb69fd</td>
</tr>
<tr class="even">
<td>node2</td>
<td>192.168.1.102:6379</td>
<td>fbe66448ee1baefa6e9fbd55e778c1d09054b59a</td>
</tr>
<tr class="odd">
<td>node3</td>
<td>192.168.1.103:6379</td>
<td>a20b6da956145cfa06ed55159456de8259d9f246</td>
</tr>
</tbody>
</table>
<p>主从配置<br />
<img
src="https://raw.githubusercontent.com/lwmfjc/lwmfjc.github.io.resource/main/img/image-20230414104528632.png"
alt="image-20230414104528632" /></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">node1:6380-&gt;node2:6379</span></span><br><span class="line">node1:6380&gt; cluster replicate 95b2dcd681674398d22817728af08c31d4bd4872</span><br><span class="line">OK</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">node2:6380-&gt;node3:6379</span></span><br><span class="line">node2:6380&gt; cluster replicate f1151c2350820b35e117d3c32b59b64917688745</span><br><span class="line">OK</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">node3:6380-&gt;node1:6379</span></span><br><span class="line">node3:6380&gt; cluster replicate fd6acb4af8afa5ddd31cf559ee2c80ffcbea456f</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<p>再一次查看节点信息，出现了master，slave</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">node3:6380&gt; cluster nodes</span><br><span class="line">4aeeaa0d87b91712576c6e995b355fe4a87b24e0 192.168.1.101:6380@16380 slave fbe66448ee1baefa6e9fbd55e778c1d09054b59a 0 1681465221000 0 connected</span><br><span class="line">43cdb0cd626a0341cf0c9fa31832735c5341a89b 192.168.1.103:6380@16380 myself,slave e13c04818944108ee3b0690d836466b4c0eb69fd 0 1681465222000 1 connected</span><br><span class="line">fbe66448ee1baefa6e9fbd55e778c1d09054b59a 192.168.1.102:6379@16379 master - 0 1681465223000 0 connected</span><br><span class="line">e13c04818944108ee3b0690d836466b4c0eb69fd 192.168.1.101:6379@16379 master - 0 1681465222000 1 connected</span><br><span class="line">a20b6da956145cfa06ed55159456de8259d9f246 192.168.1.103:6379@16379 master - 0 1681465221814 2 connected</span><br><span class="line">84384230f256fae73ab5bbaf34b0479b67602d6e 192.168.1.102:6380@16380 slave a20b6da956145cfa06ed55159456de8259d9f246 0 1681465223880 2 connected</span><br></pre></td></tr></table></figure>
<h3 id="分配槽位">分配槽位</h3>
<p>只对主库分配，从库不进行分配<br />
<figure class="highlight plaintext"><figcaption><span>16384 / 3 ``` 5461</span></figcaption><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">下面平均分配到3个master中，其中: </span><br><span class="line"></span><br><span class="line">| 节点       | 槽位数量                  |</span><br><span class="line">| ---------- | ------------------------- |</span><br><span class="line">| node1:6379 | 0 - 5461 【多分配了一个】 |</span><br><span class="line">| node2:6379 | 5461 - 10922              |</span><br><span class="line">| node3:6379 | 10922 - 16383             |</span><br><span class="line"></span><br><span class="line"> ```shell</span><br><span class="line">redis-cli -h node1 -p 6379 cluster addslots &#123;0..5461&#125;</span><br><span class="line">redis-cli -h node2 -p 6379 cluster addslots &#123;5462..10922&#125;</span><br><span class="line">redis-cli -h node3 -p 6379 cluster addslots &#123;10923..16383&#125;</span><br><span class="line">redis-cli -h node3 -p 6379</span><br><span class="line">node1:6379&gt; cluster nodes</span><br><span class="line">84384230f256fae73ab5bbaf34b0479b67602d6e 192.168.1.102:6380@16380 slave a20b6da956145cfa06ed55159456de8259d9f246 0 1681467951000 2 connected</span><br><span class="line">e13c04818944108ee3b0690d836466b4c0eb69fd 192.168.1.101:6379@16379 myself,master - 0 1681467948000 1 connected 0-5461</span><br><span class="line">fbe66448ee1baefa6e9fbd55e778c1d09054b59a 192.168.1.102:6379@16379 master - 0 1681467949000 0 connected 5462-10922</span><br><span class="line">43cdb0cd626a0341cf0c9fa31832735c5341a89b 192.168.1.103:6380@16380 slave e13c04818944108ee3b0690d836466b4c0eb69fd 0 1681467949690 1 connected</span><br><span class="line">a20b6da956145cfa06ed55159456de8259d9f246 192.168.1.103:6379@16379 master - 0 1681467947626 2 connected 10923-16383</span><br><span class="line">4aeeaa0d87b91712576c6e995b355fe4a87b24e0 192.168.1.101:6380@16380 slave fbe66448ee1baefa6e9fbd55e778c1d09054b59a 0 1681467951745 0 connected</span><br></pre></td></tr></table></figure></p>
<p>检查集群状态是否OK</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">node1:6379&gt; cluster info</span><br><span class="line">cluster_state:ok</span><br><span class="line">cluster_slots_assigned:16384</span><br><span class="line">cluster_slots_ok:16384</span><br><span class="line">cluster_slots_pfail:0</span><br><span class="line">cluster_slots_fail:0</span><br><span class="line">cluster_known_nodes:6</span><br><span class="line">cluster_size:3</span><br><span class="line">cluster_current_epoch:5</span><br><span class="line">cluster_my_epoch:1</span><br><span class="line">cluster_stats_messages_ping_sent:3461</span><br><span class="line">cluster_stats_messages_pong_sent:3530</span><br><span class="line">cluster_stats_messages_meet_sent:5</span><br><span class="line">cluster_stats_messages_sent:6996</span><br><span class="line">cluster_stats_messages_ping_received:3530</span><br><span class="line">cluster_stats_messages_pong_received:3466</span><br><span class="line">cluster_stats_messages_received:6996</span><br></pre></td></tr></table></figure>
<h2 id="自动集群搭建">自动集群搭建</h2>
<p><strong>假设所有的节点都已经重置过，没有主从状态，也未加入任何集群。</strong></p>
<blockquote>
<p>Redis5之前使用redis-trib.rb脚本搭建</p>
<p>redis-trib.rb脚本使用ruby语言编写，所以想要运行次脚本，我们必须安装Ruby环境。安装命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum -y install centos-release-scl-rh</span><br><span class="line">yum -y install rh-ruby23  </span><br><span class="line">scl enable rh-ruby23 bash</span><br><span class="line">gem install redis</span><br></pre></td></tr></table></figure>
<p>安装完成后，我们可以使用 ruby -v 查看版本信息。</p>
<figure>
<img
src="https://raw.githubusercontent.com/lwmfjc/lwmfjc.github.io.resource/main/img/1120165-20200221181647318-2083171766.png"
alt="img" />
<figcaption aria-hidden="true">img</figcaption>
</figure>
<p>Ruby环境安装完成后。运行如下命令：</p>
<p><code>redis-trib.rb create --replicas 1 192.168.14.101:6379 192.168.14.102:6380 192.168.14.103:6381 192.168.14.101:6382 192.168.14.102:6383 192.168.14.103:6384</code></p>
</blockquote>
<p><strong>前面我们就说过，redis5.0之后已经将redis-trib.rb
脚本的功能全部集成到redis-cli中了，所以我们直接使用如下命令即可：</strong></p>
<p><code>redis-cli -h node3 -p 6379 cluster reset hard</code></p>
<p>此时所有节点都是master且已经在运行中<br />
此时运行</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">redis-cli -a <span class="variable">$&#123;password&#125;</span> --cluster create 192.168.1.101:6379 192.168.1.102:6379 192.168.1.103:6379 192.168.1.103:6380 192.168.1.101:6380 192.168.1.102:6380  --cluster-replicas 1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果有密码，一般情况下集群下的所有节点使用同样的密码</span></span><br><span class="line">redis-cli --cluster create 192.168.1.101:6379 192.168.1.102:6379 192.168.1.103:6379 192.168.1.103:6380 192.168.1.101:6380 192.168.1.102:6380  --cluster-replicas 1</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 6 nodes...</span></span><br><span class="line">Master[0] -&gt; Slots 0 - 5460</span><br><span class="line">Master[1] -&gt; Slots 5461 - 10922</span><br><span class="line">Master[2] -&gt; Slots 10923 - 16383</span><br><span class="line">Adding replica 192.168.1.102:6380 to 192.168.1.101:6379</span><br><span class="line">Adding replica 192.168.1.103:6380 to 192.168.1.102:6379</span><br><span class="line">Adding replica 192.168.1.101:6380 to 192.168.1.103:6379</span><br><span class="line">M: 24ea7569f0a433eb9706d991f21ae49ec21e48cf 192.168.1.101:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">M: 518fc32f556b10d4b8f83bda420d01aaeeb25f51 192.168.1.102:6379</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">M: c021bdbaf1c3a476616781c25dbc2b3042ed6f10 192.168.1.103:6379</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">S: 25e44d3ff2d94400b3c53d66993fc99332adffe4 192.168.1.103:6380</span><br><span class="line">   replicates 518fc32f556b10d4b8f83bda420d01aaeeb25f51</span><br><span class="line">S: a6159c5dda95017ba5433f597ea4d18780868dfc 192.168.1.101:6380</span><br><span class="line">   replicates c021bdbaf1c3a476616781c25dbc2b3042ed6f10</span><br><span class="line">S: a0e986c4cfb914f34efc8f6ea07cb9b72b615593 192.168.1.102:6380</span><br><span class="line">   replicates 24ea7569f0a433eb9706d991f21ae49ec21e48cf</span><br><span class="line">Can I set the above configuration? (type &#x27;yes&#x27; to accept): yes</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Nodes configuration updated</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Assign a different config epoch to each node</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Sending CLUSTER MEET messages to <span class="built_in">join</span> the cluster</span></span><br><span class="line">Waiting for the cluster to join</span><br><span class="line">.</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 192.168.1.101:6379)</span></span><br><span class="line">M: 24ea7569f0a433eb9706d991f21ae49ec21e48cf 192.168.1.101:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: a0e986c4cfb914f34efc8f6ea07cb9b72b615593 192.168.1.102:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 24ea7569f0a433eb9706d991f21ae49ec21e48cf</span><br><span class="line">S: 25e44d3ff2d94400b3c53d66993fc99332adffe4 192.168.1.103:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 518fc32f556b10d4b8f83bda420d01aaeeb25f51</span><br><span class="line">M: c021bdbaf1c3a476616781c25dbc2b3042ed6f10 192.168.1.103:6379</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: a6159c5dda95017ba5433f597ea4d18780868dfc 192.168.1.101:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates c021bdbaf1c3a476616781c25dbc2b3042ed6f10</span><br><span class="line">M: 518fc32f556b10d4b8f83bda420d01aaeeb25f51 192.168.1.102:6379</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="keyword">for</span> open slots...</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span></span><br><span class="line">[OK] All 16384 slots covered.  #所有槽位都分配成功</span><br></pre></td></tr></table></figure>
<p>随便使用一个节点查询：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-cli -h node1 -p 6380 cluster nodes                                                                                                                          </span><br><span class="line">25e44d3ff2d94400b3c53d66993fc99332adffe4 192.168.1.103:6380@16380 slave 518fc32f556b10d4b8f83bda420d01aaeeb25f51 0 1681482908718 2 connected</span><br><span class="line">518fc32f556b10d4b8f83bda420d01aaeeb25f51 192.168.1.102:6379@16379 master - 0 1681482906668 2 connected 5461-10922</span><br><span class="line">24ea7569f0a433eb9706d991f21ae49ec21e48cf 192.168.1.101:6379@16379 master - 0 1681482908000 1 connected 0-5460</span><br><span class="line">c021bdbaf1c3a476616781c25dbc2b3042ed6f10 192.168.1.103:6379@16379 master - 0 1681482907000 3 connected 10923-16383</span><br><span class="line">a0e986c4cfb914f34efc8f6ea07cb9b72b615593 192.168.1.102:6380@16380 slave 24ea7569f0a433eb9706d991f21ae49ec21e48cf 0 1681482909743 1 connected</span><br><span class="line">a6159c5dda95017ba5433f597ea4d18780868dfc 192.168.1.101:6380@16380 myself,slave c021bdbaf1c3a476616781c25dbc2b3042ed6f10 0 1681482908000 3 connected</span><br></pre></td></tr></table></figure>
<p>如上，槽位都已经平均分配完，且主从关系也配置好了<br />
<img
src="https://raw.githubusercontent.com/lwmfjc/lwmfjc.github.io.resource/main/img/image-20230414225420457.png"
alt="image-20230414225420457" /></p>
<p>弊端：通过该方式创建的带有从节点的机器<strong>不能够自己手动指定主节点</strong>，所以如果需要指定的话，需要自己手动指定</p>
<blockquote>
<ol type="1">
<li>a:
先使用<code>redis-cli --cluster create 192.168.163.132:6379 192.168.163.132:6380 192.168.163.132:6381</code><br />
b:或```redis-cli --cluster add-node 192.168.163.132:6382
192.168.163.132:6379<br />
<strong>说明：b:为一个指定集群添加节点，需要先连到该集群的任意一个节点IP（192.168.163.132:6379），再把新节点加入。该2个参数的顺序有要求：新加入的节点放前面</strong></li>
<li>通过<code>redis-cli --cluster add-node 192.168.163.132:6382 192.168.163.132:6379 --cluster-slave --cluster-master-id 117457eab5071954faab5e81c3170600d5192270</code>来处理。<br />
<strong>说明：把6382节点加入到6379节点的集群中，并且当做node_id为
117457eab5071954faab5e81c3170600d5192270 的从节点。如果不指定
--cluster-master-id 会随机分配到任意一个主节点。</strong></li>
<li>总结：也就是先创建主节点，再创建从节点就是了</li>
</ol>
</blockquote>
<h1 id="moved重定向">MOVED重定向</h1>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-cli -h node1 -p 6379</span><br><span class="line">node1:6379&gt; set k1 &quot;v1&quot;</span><br><span class="line">(error) MOVED 12706 192.168.1.103:6379</span><br><span class="line">node1:6379&gt; get k1</span><br><span class="line">(error) MOVED 12706 192.168.1.103:6379</span><br></pre></td></tr></table></figure>
<p>//上面没有设置成功，(连接时)使用下面的命令，Redis集群会自动进行MOVED重定向</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-cli -c -h node1 -p 6379</span><br><span class="line">node1:6379&gt; get k1</span><br><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [12706] located at 192.168.1.103:6379</span></span><br><span class="line">(nil)</span><br><span class="line">192.168.1.103:6379&gt; set k1 &quot;v1&quot;</span><br><span class="line">OK</span><br><span class="line">192.168.1.103:6379&gt; get k1</span><br><span class="line">&quot;v1&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">如上，会自动给你切换到slot对应的机器上</span></span><br></pre></td></tr></table></figure>
<p>//在master3的slave3上查找数据</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-cli -h node2 -p 6380 -c</span><br><span class="line">node2:6380&gt; keys *</span><br><span class="line">1) &quot;k1&quot;</span><br><span class="line">node2:6380&gt; get k1</span><br><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [12706] located at 192.168.1.103:6379</span></span><br><span class="line">&quot;v1&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 1 只有master分配了槽位，所以会重定向到master3去取数据</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 2 同一个槽位不能同时分配给2个节点</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 3 在redis的官方文档中，对redis-cluster架构上，有这样的说明：在cluster架构下，默认的，一般redis-master用于接收读写，而redis-slave则用于备份，当有请求是在向slave发起时，会直接重定向到对应key所在的master来处理。但如果不介意读取的是redis-cluster中有可能过期的数据并且对写请求不感兴趣时，则亦可通过readonly命令，将slave设置成可读，然后通过slave获取相关的key，达到读写分离。</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">readOnly设置</span></span><br><span class="line">redis-cli -h node2 -p 6380                                       </span><br><span class="line">node2:6380&gt; get k1</span><br><span class="line">(error) MOVED 12706 192.168.1.103:6379</span><br><span class="line">node2:6380&gt; keys *</span><br><span class="line">1) &quot;k1&quot;</span><br><span class="line">node2:6380&gt; readonly</span><br><span class="line">OK</span><br><span class="line">node2:6380&gt; keys *</span><br><span class="line">1) &quot;k1&quot;</span><br><span class="line">node2:6380&gt; get k1</span><br><span class="line">&quot;v1&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 重置Readonly</span></span></span><br><span class="line">node2:6380&gt; readwrite</span><br><span class="line">OK</span><br><span class="line">node2:6380&gt; get k1</span><br><span class="line">(error) MOVED 12706 192.168.1.103:6379</span><br></pre></td></tr></table></figure>
<h1 id="故障转移">故障转移</h1>
<p>关闭前</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">node2:6379&gt; cluster nodes</span><br><span class="line">f6cf3978d3397582c87480f8c335297675d4354a 192.168.1.103:6380@16380 slave fd6acb4af8afa5ddd31cf559ee2c80ffcbea456f 0 1681470413429 0 connected</span><br><span class="line">fd6acb4af8afa5ddd31cf559ee2c80ffcbea456f 192.168.1.101:6379@16379 master - 0 1681470414459 0 connected 0-5461</span><br><span class="line">95b2dcd681674398d22817728af08c31d4bd4872 192.168.1.102:6379@16379 myself,master - 0 1681470413000 4 connected 5462-10922</span><br><span class="line">f1151c2350820b35e117d3c32b59b64917688745 192.168.1.103:6379@16379 master - 0 1681470412000 5 connected 10923-16383</span><br><span class="line">83bfb30e39e3040397d995a7b1f560e8fb53c6a9 192.168.1.102:6380@16380 slave f1151c2350820b35e117d3c32b59b64917688745 0 1681470412397 5 connected</span><br><span class="line">4e9452afe7a8f53dc546b0436109bef570e03888 192.168.1.101:6380@16380 slave 95b2dcd681674398d22817728af08c31d4bd4872 0 1681470411371 4 connected</span><br></pre></td></tr></table></figure>
<p>关闭node1 master</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-cli -h node1 -p 6379 shutdown</span><br></pre></td></tr></table></figure>
<p>如下，node3的slave变成了master</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-cli -h node1 -p 6380 </span><br><span class="line">node1:6380&gt; cluster nodes</span><br><span class="line">f6cf3978d3397582c87480f8c335297675d4354a 192.168.1.103:6380@16380 master - 0 1681470479000 6 connected 0-5461 ###这里升级成了master，槽位也转移了</span><br><span class="line">83bfb30e39e3040397d995a7b1f560e8fb53c6a9 192.168.1.102:6380@16380 slave f1151c2350820b35e117d3c32b59b64917688745 0 1681470479664 5 connected</span><br><span class="line">4e9452afe7a8f53dc546b0436109bef570e03888 192.168.1.101:6380@16380 myself,slave 95b2dcd681674398d22817728af08c31d4bd4872 0 1681470479000 4 connected</span><br><span class="line">fd6acb4af8afa5ddd31cf559ee2c80ffcbea456f 192.168.1.101:6379@16379 master,fail - 1681470463058 1681470459947 0 disconnected</span><br><span class="line">95b2dcd681674398d22817728af08c31d4bd4872 192.168.1.102:6379@16379 master - 0 1681470478616 4 connected 5462-10922</span><br><span class="line">f1151c2350820b35e117d3c32b59b64917688745 192.168.1.103:6379@16379 master - 0 1681470480698 5 connected 10923-16383</span><br></pre></td></tr></table></figure>
<p>此时将6379再次上线</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-server /usr/local/redis_cluster/redis_6379/conf/redis.conf </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 此时node1的6379变成了node3的6380的从库</span></span></span><br><span class="line">node1:6379&gt; cluster nodes</span><br><span class="line">f6cf3978d3397582c87480f8c335297675d4354a 192.168.1.103:6380@16380 master - 0 1681470625000 6 connected 0-5461</span><br><span class="line">f1151c2350820b35e117d3c32b59b64917688745 192.168.1.103:6379@16379 master - 0 1681470628003 5 connected 10923-16383</span><br><span class="line">83bfb30e39e3040397d995a7b1f560e8fb53c6a9 192.168.1.102:6380@16380 slave f1151c2350820b35e117d3c32b59b64917688745 0 1681470626979 5 connected</span><br><span class="line">4e9452afe7a8f53dc546b0436109bef570e03888 192.168.1.101:6380@16380 slave 95b2dcd681674398d22817728af08c31d4bd4872 0 1681470627000 4 connected</span><br><span class="line">95b2dcd681674398d22817728af08c31d4bd4872 192.168.1.102:6379@16379 master - 0 1681470627000 4 connected 5462-10922</span><br><span class="line">fd6acb4af8afa5ddd31cf559ee2c80ffcbea456f 192.168.1.101:6379@16379 myself,slave f6cf3978d3397582c87480f8c335297675d4354a 0 1681470625000 6 connected</span><br></pre></td></tr></table></figure>
<h1 id="集群扩容">集群扩容</h1>
<h2 id="当前集群状态">当前集群状态</h2>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">▶ redis-cli -h node1 -p 6379 cluster nodes</span><br><span class="line">f635a8cdaa48e04f2531d28c103bea9dc2d8f48d 192.168.1.102:6380@16380 slave f9d707317348314a7306fdaf91da2d153590140e 0 1681527313557 5 connected</span><br><span class="line">f49300c718a7e0baf6d3e8ba4bf7e9915e8051cc 192.168.1.101:6380@16380 slave 9e9613cec2fdd48000509e9c3723d157263edd87 0 1681527313000 4 connected</span><br><span class="line">9ea59136c61207347657503fd7a78349f57e919e 192.168.1.103:6380@16380 slave fff7298fa77799434bc8ef6c74c974c21ebc47b4 0 1681527314000 0 connected</span><br><span class="line">fff7298fa77799434bc8ef6c74c974c21ebc47b4 192.168.1.101:6379@16379 myself,master - 0 1681527313000 0 connected 0-5461</span><br><span class="line">9e9613cec2fdd48000509e9c3723d157263edd87 192.168.1.102:6379@16379 master - 0 1681527314579 4 connected 5462-10922</span><br><span class="line">f9d707317348314a7306fdaf91da2d153590140e 192.168.1.103:6379@16379 master - 0 1681527312000 5 connected 10923-16383</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="新增节点配置并启动">新增节点配置并启动</h2>
<h3 id="准备">准备</h3>
<p>假设在node3新增两个端口{6390,6391}，作为新节点<br />
<strong>且 node3:6391 replicate node3:6390</strong></p>
<p>步骤：通过<code>mkdir -p /usr/local/redis_cluster/redis_63&#123;91,90&#125;/&#123;conf,pid,logs&#125;</code>创建文件夹，然后再conf目录下配置集群配置文件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">守护进行模式启动</span></span><br><span class="line">daemonize yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置数据库数量，默认数据库为0</span></span><br><span class="line">databases 16</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">绑定地址，需要修改</span></span><br><span class="line">bind node3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">绑定端口，需要修改</span></span><br><span class="line">port 6390</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pid文件存储位置，文件名需要修改</span></span><br><span class="line">pidfile /usr/local/redis_cluster/redis_6390/pid/redis_6390.pid</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">log</span>文件存储位置，文件名需要修改</span></span><br><span class="line">logfile /usr/local/redis_cluster/redis_6390/logs/redis_6390.log</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">RDB快照备份文件名，文件名需要修改</span></span><br><span class="line">dbfilename redis_6390.rdb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">本地数据库存储目录，需要修改</span></span><br><span class="line">dir /usr/local/redis_cluster/redis_6390</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">集群相关配置</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否以集群模式启动</span></span><br><span class="line">cluster-enabled yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">集群节点回应最长时间，超过该时间被认为下线</span></span><br><span class="line">cluster-node-timeout 15000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成的集群节点配置文件名，文件名需要修改</span></span><br><span class="line">cluster-config-file nodes_6390.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>目录结构</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">root@centos7103:/usr/local/redis_cluster                                                                                                                                                 </span><br><span class="line">▶ ls</span><br><span class="line">redis6  redis_6379  redis_6380  redis_6390  redis_6391</span><br><span class="line"></span><br><span class="line">▶ tree *90</span><br><span class="line">redis_6390</span><br><span class="line">├── conf</span><br><span class="line">│   └── redis.conf</span><br><span class="line">├── logs</span><br><span class="line">└── pid</span><br><span class="line"></span><br><span class="line">3 directories, 1 file</span><br></pre></td></tr></table></figure>
<p>启动节点</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">两个孤儿节点</span></span><br><span class="line">root@centos7103:/usr/local/redis_cluster                                                                                                                                                ⍉</span><br><span class="line">▶ redis-server /usr/local/redis_cluster/redis_6390/conf/redis.conf</span><br><span class="line"></span><br><span class="line">root@centos7103:/usr/local/redis_cluster                                                                                                                                                 </span><br><span class="line">▶ redis-server /usr/local/redis_cluster/redis_6391/conf/redis.conf</span><br><span class="line"></span><br><span class="line">root@centos7103:/usr/local/redis_cluster                                                                                                                                                 </span><br><span class="line">▶ netstat -lntup |grep redis</span><br><span class="line">tcp        0      0 192.168.1.103:6379      0.0.0.0:*               LISTEN      3484/redis-server n </span><br><span class="line">tcp        0      0 192.168.1.103:6380      0.0.0.0:*               LISTEN      3507/redis-server n </span><br><span class="line">tcp        0      0 192.168.1.103:6390      0.0.0.0:*               LISTEN      5590/redis-server n </span><br><span class="line">tcp        0      0 192.168.1.103:6391      0.0.0.0:*               LISTEN      5616/redis-server n </span><br><span class="line">tcp        0      0 192.168.1.103:16379     0.0.0.0:*               LISTEN      3484/redis-server n </span><br><span class="line">tcp        0      0 192.168.1.103:16380     0.0.0.0:*               LISTEN      3507/redis-server n </span><br><span class="line">tcp        0      0 192.168.1.103:16390     0.0.0.0:*               LISTEN      5590/redis-server n </span><br><span class="line">tcp        0      0 192.168.1.103:16391     0.0.0.0:*               LISTEN      5616/redis-server n </span><br></pre></td></tr></table></figure>
<h3 id="添加主节点">添加主节点</h3>
<p>将新节点加入到node1:6379 [0,5460]所在的集群中<br />
加入前</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-cli -h node3 -p 6390</span><br><span class="line">node3:6390&gt; cluster nodes</span><br><span class="line">b014cfbeff6f9668ec9592cbc8aa874bda2d8d6b :6390@16390 myself,master - 0 0 0 connected</span><br></pre></td></tr></table></figure>
<p>加入</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在node1客户端操作，将103:6390添加到101:6379所在的集群中</span></span><br><span class="line">redis-cli -h node1 -p 6379 --cluster add-node 192.168.1.103:6390 192.168.1.101:6379</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Adding node 192.168.1.103:6390 to cluster 192.168.1.101:6379</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 192.168.1.101:6379)</span></span><br><span class="line">M: fff7298fa77799434bc8ef6c74c974c21ebc47b4 192.168.1.101:6379</span><br><span class="line">   slots:[0-5461] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: f635a8cdaa48e04f2531d28c103bea9dc2d8f48d 192.168.1.102:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates f9d707317348314a7306fdaf91da2d153590140e</span><br><span class="line">S: f49300c718a7e0baf6d3e8ba4bf7e9915e8051cc 192.168.1.101:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 9e9613cec2fdd48000509e9c3723d157263edd87</span><br><span class="line">S: 9ea59136c61207347657503fd7a78349f57e919e 192.168.1.103:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates fff7298fa77799434bc8ef6c74c974c21ebc47b4</span><br><span class="line">M: 9e9613cec2fdd48000509e9c3723d157263edd87 192.168.1.102:6379</span><br><span class="line">   slots:[5462-10922] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: f9d707317348314a7306fdaf91da2d153590140e 192.168.1.103:6379</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="keyword">for</span> open slots...</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span></span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Send CLUSTER MEET to node 192.168.1.103:6390 to make it <span class="built_in">join</span> the cluster.</span></span><br><span class="line">[OK] New node added correctly.</span><br></pre></td></tr></table></figure>
<p>加入后</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">▶ redis-cli -h node1 -p 6379 cluster nodes                                           </span><br><span class="line">b014cfbeff6f9668ec9592cbc8aa874bda2d8d6b 192.168.1.103:6390@16390 master - 0 1681527533967 6 connected</span><br><span class="line">f635a8cdaa48e04f2531d28c103bea9dc2d8f48d 192.168.1.102:6380@16380 slave f9d707317348314a7306fdaf91da2d153590140e 0 1681527534990 5 connected</span><br><span class="line">f49300c718a7e0baf6d3e8ba4bf7e9915e8051cc 192.168.1.101:6380@16380 slave 9e9613cec2fdd48000509e9c3723d157263edd87 0 1681527533000 4 connected</span><br><span class="line">9ea59136c61207347657503fd7a78349f57e919e 192.168.1.103:6380@16380 slave fff7298fa77799434bc8ef6c74c974c21ebc47b4 0 1681527533000 0 connected</span><br><span class="line">fff7298fa77799434bc8ef6c74c974c21ebc47b4 192.168.1.101:6379@16379 myself,master - 0 1681527529000 0 connected 0-5461</span><br><span class="line">9e9613cec2fdd48000509e9c3723d157263edd87 192.168.1.102:6379@16379 master - 0 1681527534000 4 connected 5462-10922</span><br><span class="line">f9d707317348314a7306fdaf91da2d153590140e 192.168.1.103:6379@16379 master - 0 1681527533000 5 connected 10923-16383</span><br></pre></td></tr></table></figure>
<p>为他分配槽位</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">最后一个参数，表示原来集群中任意一个节点，这里会将源节点所在集群的一部分分给新增节点</span></span><br><span class="line">redis-cli -h node1 -p 6379 --cluster reshard 192.168.1.101:6379</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#过程</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">后面的2000表示分配2000个槽位给新增节点</span></span><br><span class="line">How many slots do you want to move (from 1 to 16384)? 2000 #输入</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">表示接受节点的NodeId,填新增节点6390的</span></span><br><span class="line">What is the receiving node ID? b014cfbeff6f9668ec9592cbc8aa874bda2d8d6b #输入</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">这里填槽的来源，要么填all，表示所有master节点都拿出一部分槽位分配给新增节点；</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">要么填某个原有NodeId，表示这个节点拿出一部分槽位给新增节点</span></span><br><span class="line">Please enter all the source node IDs.</span><br><span class="line">  Type &#x27;all&#x27; to use all the nodes as source nodes for the hash slots.</span><br><span class="line">  Type &#x27;done&#x27; once you entered all the source nodes IDs.</span><br><span class="line">Source node #1: 7e900adc7f977cfcccef12d48c7a29b64c4344c2</span><br><span class="line">Source node #2: done</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这里把node1:6379 拿出了2000个槽位给新节点</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure>
<img
src="https://raw.githubusercontent.com/lwmfjc/lwmfjc.github.io.resource/main/img/image-20230415115032010.png"
alt="image-20230415115032010" />
<figcaption aria-hidden="true">image-20230415115032010</figcaption>
</figure>
<p>结果：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">? redis-cli -h node1 -p 6380 cluster nodes                       </span><br><span class="line">259b65d7f3d1eac2716f7ae00cc6c1db27a55b27 192.168.1.103:6379@16379 master - 0 1681530641000 2 connected 10923-16383</span><br><span class="line">429ed631dbf09ba846a5371b707defe17b9f8c8e 192.168.1.101:6380@16380 myself,slave 9355d72df6e9dc2643ac1c819cd2e496fb1aed60 0 1681530643000 4 connected</span><br><span class="line">9355d72df6e9dc2643ac1c819cd2e496fb1aed60 192.168.1.102:6379@16379 master - 0 1681530641000 4 connected 5462-10922</span><br><span class="line">81e1e03230ed7700028fa56155e9531b48791164 192.168.1.103:6390@16390 master - 0 1681530644122 6 connected 0-1999</span><br><span class="line">a04347e1af8930324dab7ae85f912449475a487f 192.168.1.102:6380@16380 slave 259b65d7f3d1eac2716f7ae00cc6c1db27a55b27 0 1681530643093 2 connected</span><br><span class="line">92a9d6b988dcf8a219de0247975d8e341072134d 192.168.1.103:6380@16380 slave 7e900adc7f977cfcccef12d48c7a29b64c4344c2 0 1681530643000 1 connected</span><br><span class="line">7e900adc7f977cfcccef12d48c7a29b64c4344c2 192.168.1.101:6379@16379 master - 0 1681530642063 1 connected 2000-5461</span><br></pre></td></tr></table></figure>
<h3 id="添加从节点">添加从节点</h3>
<p>将节点添加到集群中</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">▶ redis-cli -h node1 -p 6379 --cluster add-node 192.168.1.103:6391 192.168.1.101:6379</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Adding node 192.168.1.103:6391 to cluster 192.168.1.101:6379</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 192.168.1.101:6379)</span></span><br><span class="line">M: 7e900adc7f977cfcccef12d48c7a29b64c4344c2 192.168.1.101:6379</span><br><span class="line">   slots:[2000-5461] (3462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 9355d72df6e9dc2643ac1c819cd2e496fb1aed60 192.168.1.102:6379</span><br><span class="line">   slots:[5462-10922] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: a04347e1af8930324dab7ae85f912449475a487f 192.168.1.102:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 259b65d7f3d1eac2716f7ae00cc6c1db27a55b27</span><br><span class="line">M: 259b65d7f3d1eac2716f7ae00cc6c1db27a55b27 192.168.1.103:6379</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 81e1e03230ed7700028fa56155e9531b48791164 192.168.1.103:6390</span><br><span class="line">   slots:[0-1999] (2000 slots) master</span><br><span class="line">S: 429ed631dbf09ba846a5371b707defe17b9f8c8e 192.168.1.101:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 9355d72df6e9dc2643ac1c819cd2e496fb1aed60</span><br><span class="line">S: 92a9d6b988dcf8a219de0247975d8e341072134d 192.168.1.103:6380</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 7e900adc7f977cfcccef12d48c7a29b64c4344c2</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="keyword">for</span> open slots...</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span></span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Send CLUSTER MEET to node 192.168.1.103:6391 to make it <span class="built_in">join</span> the cluster.</span></span><br><span class="line">[OK] New node added correctly.</span><br></pre></td></tr></table></figure>
<p>建立主从关系</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">▶ redis-cli -h node1 -p 6380 cluster nodes                                           </span><br><span class="line">9babc7adc86da25ba501bd5bc007300dc04743a9 192.168.1.103:6391@16391 master - 0 1681530812000 0 connected</span><br><span class="line">259b65d7f3d1eac2716f7ae00cc6c1db27a55b27 192.168.1.103:6379@16379 master - 0 1681530808000 2 connected 10923-16383</span><br><span class="line">429ed631dbf09ba846a5371b707defe17b9f8c8e 192.168.1.101:6380@16380 myself,slave 9355d72df6e9dc2643ac1c819cd2e496fb1aed60 0 1681530811000 4 connected</span><br><span class="line">9355d72df6e9dc2643ac1c819cd2e496fb1aed60 192.168.1.102:6379@16379 master - 0 1681530810000 4 connected 5462-10922</span><br><span class="line">81e1e03230ed7700028fa56155e9531b48791164 192.168.1.103:6390@16390 master - 0 1681530810000 6 connected 0-1999</span><br><span class="line">a04347e1af8930324dab7ae85f912449475a487f 192.168.1.102:6380@16380 slave 259b65d7f3d1eac2716f7ae00cc6c1db27a55b27 0 1681530811246 2 connected</span><br><span class="line">92a9d6b988dcf8a219de0247975d8e341072134d 192.168.1.103:6380@16380 slave 7e900adc7f977cfcccef12d48c7a29b64c4344c2 0 1681530812275 1 connected</span><br><span class="line">7e900adc7f977cfcccef12d48c7a29b64c4344c2 192.168.1.101:6379@16379 master - 0 1681530809182 1 connected 2000-5461</span><br><span class="line"></span><br><span class="line">root@centos7101:/usr/local/redis_cluster                                                                                                                                </span><br><span class="line">▶ redis-cli -h node3 -p 6391 cluster replicate 81e1e03230ed7700028fa56155e9531b48791164</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">root@centos7101:/usr/local/redis_cluster                                                                     # 验证                                                           </span><br><span class="line">▶ redis-cli -h node1 -p 6380 cluster nodes                                             </span><br><span class="line">9babc7adc86da25ba501bd5bc007300dc04743a9 192.168.1.103:6391@16391 slave 81e1e03230ed7700028fa56155e9531b48791164 0 1681530870000 6 connected</span><br><span class="line">259b65d7f3d1eac2716f7ae00cc6c1db27a55b27 192.168.1.103:6379@16379 master - 0 1681530868642 2 connected 10923-16383</span><br><span class="line">429ed631dbf09ba846a5371b707defe17b9f8c8e 192.168.1.101:6380@16380 myself,slave 9355d72df6e9dc2643ac1c819cd2e496fb1aed60 0 1681530867000 4 connected</span><br><span class="line">9355d72df6e9dc2643ac1c819cd2e496fb1aed60 192.168.1.102:6379@16379 master - 0 1681530871715 4 connected 5462-10922</span><br><span class="line">81e1e03230ed7700028fa56155e9531b48791164 192.168.1.103:6390@16390 master - 0 1681530868000 6 connected 0-1999</span><br><span class="line">a04347e1af8930324dab7ae85f912449475a487f 192.168.1.102:6380@16380 slave 259b65d7f3d1eac2716f7ae00cc6c1db27a55b27 0 1681530869000 2 connected</span><br><span class="line">92a9d6b988dcf8a219de0247975d8e341072134d 192.168.1.103:6380@16380 slave 7e900adc7f977cfcccef12d48c7a29b64c4344c2 0 1681530870000 1 connected</span><br><span class="line">7e900adc7f977cfcccef12d48c7a29b64c4344c2 192.168.1.101:6379@16379 master - 0 1681530870693 1 connected 2000-5461</span><br></pre></td></tr></table></figure>
<p>测试</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">node1:6380&gt; set 18 a</span><br><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [511] located at 192.168.1.103:6390</span></span><br><span class="line">OK</span><br><span class="line">192.168.1.103:6390&gt; get 18</span><br><span class="line">&quot;a&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在node3:6391上尝试-&gt;说明从机上是有数据的</span></span><br><span class="line">▶ redis-cli -h node3 -p 6391    </span><br><span class="line">node3:6391&gt; get 18</span><br><span class="line">(error) MOVED 511 192.168.1.103:6390</span><br><span class="line">node3:6391&gt; readonly </span><br><span class="line">OK</span><br><span class="line">node3:6391&gt; get 18</span><br><span class="line">&quot;a&quot;</span><br><span class="line">node3:6391&gt; keys *</span><br><span class="line">1) &quot;18&quot;</span><br></pre></td></tr></table></figure>
<h3 id="集群收缩">集群收缩</h3>
<h4 id="迁移待移除节点的槽位">迁移待移除节点的槽位</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当前节点信息</span></span><br><span class="line">429ed631dbf09ba846a5371b707defe17b9f8c8e 192.168.1.101:6380@16380 slave 9355d72df6e9dc2643ac1c819cd2e496fb1aed60 0 1681531264142 4 connected</span><br><span class="line">7e900adc7f977cfcccef12d48c7a29b64c4344c2 192.168.1.101:6379@16379 master - 0 1681531260000 1 connected 2000-5461</span><br><span class="line">9355d72df6e9dc2643ac1c819cd2e496fb1aed60 192.168.1.102:6379@16379 myself,master - 0 1681531261000 4 connected 5462-10922</span><br><span class="line">259b65d7f3d1eac2716f7ae00cc6c1db27a55b27 192.168.1.103:6379@16379 master - 0 1681531262088 2 connected 10923-16383</span><br><span class="line">9babc7adc86da25ba501bd5bc007300dc04743a9 192.168.1.103:6391@16391 slave 81e1e03230ed7700028fa56155e9531b48791164 0 1681531265170 6 connected</span><br><span class="line">81e1e03230ed7700028fa56155e9531b48791164 192.168.1.103:6390@16390 master - 0 1681531264000 6 connected 0-1999</span><br><span class="line">92a9d6b988dcf8a219de0247975d8e341072134d 192.168.1.103:6380@16380 slave 7e900adc7f977cfcccef12d48c7a29b64c4344c2 0 1681531263115 1 connected</span><br><span class="line">a04347e1af8930324dab7ae85f912449475a487f 192.168.1.102:6380@16380 slave 259b65d7f3d1eac2716f7ae00cc6c1db27a55b27 0 1681531260038 2 connected</span><br></pre></td></tr></table></figure>
<p>移除并将槽位分配给其他节点</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-cli -p 6379 -h node1 --cluster reshard --cluster-from bee9c03b1c4592119695a17472847736128c8603 --cluster-to 644b722eb996aeb392a8190b29cfdbe95536af9a --cluster-slots 2000 192.168.1.101:6379</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用哪个客户端，最后的ip:host-&gt;对该ip host所在集群的from和to操作，进行转移</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">结果</span></span><br><span class="line"> redis-cli -h node1 -p 6380 cluster nodes</span><br><span class="line">bee9c03b1c4592119695a17472847736128c8603 192.168.1.103:6390@16390 master - 0 1681532501000 6 connected</span><br><span class="line">f525c38c1a78e997a96315ca982f969c51500e86 192.168.1.102:6379@16379 master - 0 1681532501000 0 connected 5462-10922</span><br><span class="line">2b905b7e2480d80bb7c7aa47940e9636697a7d4c 192.168.1.103:6379@16379 master - 0 1681532503071 2 connected 10923-16383</span><br><span class="line">644b722eb996aeb392a8190b29cfdbe95536af9a 192.168.1.101:6379@16379 master - 0 1681532502000 8 connected 0-5461</span><br><span class="line">180113f8ceeba0b17b4a122caa62d36e99141225 192.168.1.103:6391@16391 slave 644b722eb996aeb392a8190b29cfdbe95536af9a 0 1681532503000 8 connected</span><br><span class="line">576e15ed8ac1f4632e5f0917c43d41f7e26dc1e0 192.168.1.101:6380@16380 myself,slave f525c38c1a78e997a96315ca982f969c51500e86 0 1681532500000 0 connected</span><br><span class="line">7ff6ce4b934027c1cdb8720169873f8e97474885 192.168.1.102:6380@16380 slave 2b905b7e2480d80bb7c7aa47940e9636697a7d4c 0 1681532504083 2 connected</span><br><span class="line">75f8df2756a83c121b5637e3a381fa8ebfb9204d 192.168.1.103:6380@16380 slave 644b722eb996aeb392a8190b29cfdbe95536af9a 0 1681532501053 8 connected</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 查看</span></span></span><br><span class="line">▶ redis-cli -h node1 -p 6379              </span><br><span class="line">node1:6379&gt; get 18</span><br><span class="line">&quot;a&quot;</span><br><span class="line">node1:6379&gt; keys *</span><br><span class="line">1) &quot;18&quot;</span><br><span class="line">node1:6379&gt; exit</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 看看还在不在103:6390上</span></span></span><br><span class="line">redis-cli -h node3 -p 6390       </span><br><span class="line">node3:6390&gt; keys *</span><br><span class="line">(empty array)</span><br><span class="line">node3:6390&gt; get 18</span><br><span class="line">(error) MOVED 511 192.168.1.101:6379</span><br></pre></td></tr></table></figure>
<p>槽位调整成功</p>
<blockquote>
<p>注意，node3:6391原本replicate
node3:6390，但是node3:6390没有槽位了，所以他就跟到槽位所在的node上了，即：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">644b722eb996aeb392a8190b29cfdbe95536af9a 192.168.1.101:6379@16379 master - 0 1681532502000 8 connected 0-5461</span><br><span class="line">180113f8ceeba0b17b4a122caa62d36e99141225 192.168.1.103:6391@16391 slave 644b722eb996aeb392a8190b29cfdbe95536af9a 0 1681532503000 8 connected</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="移除待删除的主从节点">移除待删除的主从节点</h4>
<p>先移除从节点，再移除主节点，防止触发集群故障转移(如上，这里可能并不会，因为已经没有节点replicate
node3:6390了)</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-cli -p 6379 -h node1 --cluster del-node 192.168.1.102:6380 180113f8ceeba0b17b4a122caa62d36e99141225</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ip+port :哪个节点所在的集群</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">nodeId</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Removing node 180113f8ceeba0b17b4a122caa62d36e99141225 from cluster 192.168.1.102:6380</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Sending CLUSTER RESET SOFT to the deleted node.</span></span><br></pre></td></tr></table></figure>
<p>移除主节点</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">redis-cli -p 6379 -h node1 --cluster del-node 192.168.1.102:6380 bee9c03b1c4592119695a17472847736128c8603</span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Removing node bee9c03b1c4592119695a17472847736128c8603 from cluster 192.168.1.102:6380</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Sending CLUSTER RESET SOFT to the deleted node.</span></span><br></pre></td></tr></table></figure>
<p>查看状态（移除成功）</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">▶ redis-cli -h node1 -p 6379 cluster nodes                                                                 </span><br><span class="line">644b722eb996aeb392a8190b29cfdbe95536af9a 192.168.1.101:6379@16379 myself,master - 0 1681533116000 8 connected 0-5461</span><br><span class="line">75f8df2756a83c121b5637e3a381fa8ebfb9204d 192.168.1.103:6380@16380 slave 644b722eb996aeb392a8190b29cfdbe95536af9a 0 1681533119000 8 connected</span><br><span class="line">f525c38c1a78e997a96315ca982f969c51500e86 192.168.1.102:6379@16379 master - 0 1681533120514 0 connected 5462-10922</span><br><span class="line">2b905b7e2480d80bb7c7aa47940e9636697a7d4c 192.168.1.103:6379@16379 master - 0 1681533119492 2 connected 10923-16383</span><br><span class="line">576e15ed8ac1f4632e5f0917c43d41f7e26dc1e0 192.168.1.101:6380@16380 slave f525c38c1a78e997a96315ca982f969c51500e86 0 1681533118463 0 connected</span><br><span class="line">7ff6ce4b934027c1cdb8720169873f8e97474885 192.168.1.102:6380@16380 slave 2b905b7e2480d80bb7c7aa47940e9636697a7d4c 0 1681533118000 2 connected</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="cluster命令">cluster命令</h1>
<p>以下是集群中常用的可执行命令，命令执行格式为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cluster 下表命令</span><br></pre></td></tr></table></figure>
<p>命令如下，未全，如果想了解更多请执行cluster help操作：</p>
<table>
<colgroup>
<col style="width: 34%" />
<col style="width: 65%" />
</colgroup>
<thead>
<tr class="header">
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>INFO</td>
<td>返回当前集群信息</td>
</tr>
<tr class="even">
<td>MEET <ip> <port> [<bus-port>]</td>
<td>添加一个节点至当前集群</td>
</tr>
<tr class="odd">
<td>MYID</td>
<td>返回当前节点集群ID</td>
</tr>
<tr class="even">
<td>NODES</td>
<td>返回当前节点的集群信息</td>
</tr>
<tr class="odd">
<td>REPLICATE <node-id></td>
<td>将当前节点作为某一集群节点的从库</td>
</tr>
<tr class="even">
<td>FAILOVER [FORCE|TAKEOVER]</td>
<td>将当前从库升级为主库</td>
</tr>
<tr class="odd">
<td>RESET [HARD|SOFT]</td>
<td>重置当前节点信息</td>
</tr>
<tr class="even">
<td>ADDSLOTS <slot> [<slot> ...]</td>
<td>为当前集群节点增加一个或多个插槽位，推荐在bash
shell中执行，可通过{int..int}指定多个插槽位</td>
</tr>
<tr class="odd">
<td>DELSLOTS <slot> [<slot> ...]</td>
<td>为当前集群节点删除一个或多个插槽位，推荐在bash
shell中执行，可通过{int..int}指定多个插槽位</td>
</tr>
<tr class="even">
<td>FLUSHSLOTS</td>
<td>删除当前节点中所有的插槽信息</td>
</tr>
<tr class="odd">
<td>FORGET <node-id></td>
<td>从集群中删除某一节点</td>
</tr>
<tr class="even">
<td>COUNT-FAILURE-REPORTS <node-id></td>
<td>返回当前集群节点的故障报告数量</td>
</tr>
<tr class="odd">
<td>COUNTKEYSINSLOT <slot></td>
<td>返回某一插槽中的键的数量</td>
</tr>
<tr class="even">
<td>GETKEYSINSLOT <slot> <count></td>
<td>返回当前节点存储在插槽中的key名称。</td>
</tr>
<tr class="odd">
<td>KEYSLOT <key></td>
<td>返回该key的哈希槽位</td>
</tr>
<tr class="even">
<td>SAVECONFIG</td>
<td>保存当前集群配置，进行落盘操作</td>
</tr>
<tr class="odd">
<td>SLOTS</td>
<td>返回该插槽的信息</td>
</tr>
</tbody>
</table>
<h1 id="springbootrediscluster">SpringBoot+RedisCluster</h1>
<p>依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置文件yml</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="comment"># 如果是redis-cluster 不能用这种形式，否则会报错,只适合单机</span></span><br><span class="line">    <span class="comment">#Error in execution; nested exception is io.lettuce.core.</span></span><br><span class="line">    <span class="comment">#RedisCommandExecutionException: MOVED 15307 192.168.1.103:6379</span></span><br><span class="line">    <span class="comment">#host: 192.168.1.102</span></span><br><span class="line">    <span class="comment">#port: 6380</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 下面的配置,nodes写一个或者多个都行</span></span><br><span class="line">    <span class="attr">cluster:</span></span><br><span class="line">      <span class="attr">nodes:</span></span><br><span class="line"><span class="comment">#        - 192.168.1.101:6379</span></span><br><span class="line"><span class="comment">#        - 192.168.1.102:6379</span></span><br><span class="line"><span class="comment">#        - 192.168.1.101:6380</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.102</span><span class="string">:6380</span></span><br><span class="line"><span class="comment">#        - 192.168.1.103:6379</span></span><br><span class="line"><span class="comment">#        - 192.168.1.103:6380</span></span><br></pre></td></tr></table></figure>
<p>序列化处理</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        RedisSerializer&lt;String&gt; redisSerializer = <span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>();</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        <span class="comment">//key序列化方式</span></span><br><span class="line">        template.setKeySerializer(redisSerializer);</span><br><span class="line">        <span class="comment">//value序列化</span></span><br><span class="line">        template.setValueSerializer(redisSerializer);</span><br><span class="line">        <span class="comment">//value hashmap序列化</span></span><br><span class="line">        template.setHashValueSerializer(redisSerializer);</span><br><span class="line">        <span class="comment">//key haspmap序列化</span></span><br><span class="line">        template.setHashKeySerializer(redisSerializer);</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/redisTest&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">redisTest</span><span class="params">()</span>&#123;</span><br><span class="line">    redisTemplate.opsForValue().set(<span class="string">&quot;190&quot;</span>,<span class="string">&quot;hello,world&quot;</span>+<span class="keyword">new</span> <span class="title class_">Date</span>().getTime());</span><br><span class="line">    <span class="type">Object</span> <span class="variable">hello</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;190&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> hello.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="rediscluster架构原理分析">RedisCluster架构原理分析</h1>
<h2 id="基础架构数据分片">基础架构（数据分片）</h2>
<figure>
<img
src="https://raw.githubusercontent.com/lwmfjc/lwmfjc.github.io.resource/main/img/image-20230414215403801.png"
alt="image-20230414215403801" />
<figcaption aria-hidden="true">image-20230414215403801</figcaption>
</figure>
<h2 id="集群分片原理">集群分片原理</h2>
<p>如果有任意1个槽位没有被分配，则集群创建不成功。</p>
<figure>
<img
src="https://raw.githubusercontent.com/lwmfjc/lwmfjc.github.io.resource/main/img/image-20230414215902852.png"
alt="image-20230414215902852" />
<figcaption aria-hidden="true">image-20230414215902852</figcaption>
</figure>
<h2 id="启动集群原理">启动集群原理</h2>
<figure>
<img
src="https://raw.githubusercontent.com/lwmfjc/lwmfjc.github.io.resource/main/img/image-20230414220624119.png"
alt="image-20230414220624119" />
<figcaption aria-hidden="true">image-20230414220624119</figcaption>
</figure>
<h2 id="集群通信原理">集群通信原理</h2>
<figure>
<img
src="https://raw.githubusercontent.com/lwmfjc/lwmfjc.github.io.resource/main/img/image-20230414221225818.png"
alt="image-20230414221225818" />
<figcaption aria-hidden="true">image-20230414221225818</figcaption>
</figure>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/rocketmq-hm/" rel="tag"># rocketmq-hm</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/04/05/study/linux/base/base/" rel="prev" title="一些基本操作">
      <i class="fa fa-chevron-left"></i> 一些基本操作
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/04/17/study/mysql/how_mysql_run/01/" rel="next" title="01初识MySQL">
      01初识MySQL <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  
  <div class="comments">
  <script src="https://utteranc.es/client.js" repo="lwmfjc/lwmfjc.github.io.comment" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script>
  </div>
  
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E5%87%86%E5%A4%87"><span class="nav-number">1.</span> <span class="nav-text">基本准备</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84"><span class="nav-number">1.1.</span> <span class="nav-text">架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hosts%E4%BF%AE%E6%94%B9"><span class="nav-number">1.2.</span> <span class="nav-text">hosts修改</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%87%86%E5%A4%87"><span class="nav-number">1.3.</span> <span class="nav-text">集群准备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E6%AF%8F%E4%B8%AA%E8%8A%82%E7%82%B9"><span class="nav-number">1.3.1.</span> <span class="nav-text">对每个节点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B96%E4%B8%AA%E8%8A%82%E7%82%B9%E4%B8%AD%E7%9A%84%E6%AF%8F%E4%B8%80%E4%B8%AA"><span class="nav-number">1.4.</span> <span class="nav-text">配置文件修改(6个节点中的每一个)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C"><span class="nav-number">2.</span> <span class="nav-text">运行</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="nav-number">3.</span> <span class="nav-text">集群搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%8B%E5%8A%A8%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4"><span class="nav-number">3.1.</span> <span class="nav-text">手动搭建集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4"><span class="nav-number">3.1.1.</span> <span class="nav-text">加入集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E9%85%8D%E7%BD%AE"><span class="nav-number">3.1.2.</span> <span class="nav-text">主从配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E9%85%8D%E6%A7%BD%E4%BD%8D"><span class="nav-number">3.1.3.</span> <span class="nav-text">分配槽位</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="nav-number">3.2.</span> <span class="nav-text">自动集群搭建</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#moved%E9%87%8D%E5%AE%9A%E5%90%91"><span class="nav-number">4.</span> <span class="nav-text">MOVED重定向</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="nav-number">5.</span> <span class="nav-text">故障转移</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%89%A9%E5%AE%B9"><span class="nav-number">6.</span> <span class="nav-text">集群扩容</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BD%93%E5%89%8D%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="nav-number">6.1.</span> <span class="nav-text">当前集群状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%B0%E5%A2%9E%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE%E5%B9%B6%E5%90%AF%E5%8A%A8"><span class="nav-number">6.2.</span> <span class="nav-text">新增节点配置并启动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%86%E5%A4%87"><span class="nav-number">6.2.1.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="nav-number">6.2.2.</span> <span class="nav-text">添加主节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E4%BB%8E%E8%8A%82%E7%82%B9"><span class="nav-number">6.2.3.</span> <span class="nav-text">添加从节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%94%B6%E7%BC%A9"><span class="nav-number">6.2.4.</span> <span class="nav-text">集群收缩</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%81%E7%A7%BB%E5%BE%85%E7%A7%BB%E9%99%A4%E8%8A%82%E7%82%B9%E7%9A%84%E6%A7%BD%E4%BD%8D"><span class="nav-number">6.2.4.1.</span> <span class="nav-text">迁移待移除节点的槽位</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A7%BB%E9%99%A4%E5%BE%85%E5%88%A0%E9%99%A4%E7%9A%84%E4%B8%BB%E4%BB%8E%E8%8A%82%E7%82%B9"><span class="nav-number">6.2.4.2.</span> <span class="nav-text">移除待删除的主从节点</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#cluster%E5%91%BD%E4%BB%A4"><span class="nav-number">7.</span> <span class="nav-text">cluster命令</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#springbootrediscluster"><span class="nav-number">8.</span> <span class="nav-text">SpringBoot+RedisCluster</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#rediscluster%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="nav-number">9.</span> <span class="nav-text">RedisCluster架构原理分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87"><span class="nav-number">9.1.</span> <span class="nav-text">基础架构（数据分片）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E5%88%86%E7%89%87%E5%8E%9F%E7%90%86"><span class="nav-number">9.2.</span> <span class="nav-text">集群分片原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E9%9B%86%E7%BE%A4%E5%8E%9F%E7%90%86"><span class="nav-number">9.3.</span> <span class="nav-text">启动集群原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E9%80%9A%E4%BF%A1%E5%8E%9F%E7%90%86"><span class="nav-number">9.4.</span> <span class="nav-text">集群通信原理</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="刘易"
      src="https://raw.githubusercontent.com/lwmfjc/lwmfjc.github.io.resource/main/img/avatar.png">
  <p class="site-author-name" itemprop="name">刘易</p>
  <div class="site-description" itemprop="description">知命不惧 日日自新</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">201</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">38</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/lwmfjc" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;lwmfjc" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">刘易</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1.4m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">43:24</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
